@{
    ViewBag.Title = "Checkout";
    Layout = "~/Views/Shared/_CustomerLayout.cshtml";
}
@model Kaasht_Kart.Models.CheckoutViewModel

<style>
    :root {
        --color-primary: #ff9b00;
        --color-primary-dark: #0f5a2b;
        --color-success: #48bb78;
        --color-light: #f7fafc;
        --shadow-sm: 0 2px 8px rgba(0,0,0,0.06);
        --shadow-md: 0 4px 16px rgba(0,0,0,0.1);
        --shadow-lg: 0 8px 24px rgba(0,0,0,0.12);
    }

    .checkout-wrapper {
        max-width: 1200px;
        margin: 0 auto;
        padding: 40px 20px 60px;
        background: linear-gradient(135deg, #f0fdf4 0%, #ecfdf5 100%);
        min-height: 100vh;
    }

    /* Progress Steps */
    .progress-steps {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding: 0 20px;
        position: relative;
    }

        .progress-steps::before {
            content: '';
            position: absolute;
            top: 25px;
            left: 15%;
            right: 15%;
            height: 3px;
            background: #e2e8f0;
            z-index: 0;
        }

    .progress-line-active {
        position: absolute;
        top: 25px;
        left: 15%;
        height: 3px;
        background: linear-gradient(90deg, var(--color-primary), var(--color-success));
        z-index: 1;
        width: 0%;
        transition: width 0.8s ease;
    }

    .step {
        display: flex;
        flex-direction: column;
        align-items: center;
        position: relative;
        z-index: 2;
    }

    .step-icon {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background: #fff;
        border: 3px solid #e2e8f0;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        color: #94a3b8;
        margin-bottom: 10px;
        transition: all 0.5s ease;
    }

    .step.active .step-icon {
        background: var(--color-primary);
        border-color: var(--color-primary);
        color: white;
        box-shadow: 0 0 0 8px rgba(255, 155, 0, 0.1);
        animation: pulse 2s infinite;
    }

    .step.completed .step-icon {
        background: var(--color-success);
        border-color: var(--color-success);
        color: white;
        transform: scale(1.1);
        margin-left: 102px;
    }

    @@keyframes pulse {
        0%, 100% {
            box-shadow: 0 0 0 8px rgba(255, 155, 0, 0.1);
        }

        50% {
            box-shadow: 0 0 0 12px rgba(255, 155, 0, 0.05);
        }
    }

    .step-label {
        font-size: 13px;
        font-weight: 600;
        color: #94a3b8;
        text-align: center;
        transition: all 0.3s ease;
    }

    .step.active .step-label,
    .step.completed .step-label {
        color: var(--color-primary);
        font-weight: 700;
    }

    /* Main Grid */
    .checkout-grid {
        display: grid;
        grid-template-columns: 1fr 400px;
        gap: 30px;
        align-items: start;
    }

    @@media (max-width: 992px) {
        .checkout-grid {
            grid-template-columns: 1fr;
        }
    }

    /* Section Cards */
    .checkout-section {
        background: white;
        padding: 30px;
        border-radius: 16px;
        box-shadow: var(--shadow-md);
        border: 1px solid #e2e8f0;
        transition: all 0.3s ease;
    }

        .checkout-section:hover {
            box-shadow: var(--shadow-lg);
            transform: translateY(-2px);
        }

    .section-header {
        display: flex;
        align-items: center;
        gap: 12px;
        margin-bottom: 25px;
        padding-bottom: 15px;
        border-bottom: 2px solid #f1f5f9;
    }

    .section-icon {
        width: 40px;
        height: 40px;
        background: #ff9b00;
        color: white;
        border-radius: 10px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
    }

    .section-title {
        font-size: 20px;
        font-weight: 700;
        color: #1e293b;
        margin: 0;
        flex: 1;
    }

    /* User Info */
    .info-item {
        display: flex;
        align-items: flex-start;
        gap: 15px;
        padding: 15px;
        background: #f8fafc;
        border-radius: 10px;
        border-left: 4px solid var(--color-primary);
        margin-bottom: 10px;
    }

    .info-icon {
        width: 36px;
        height: 36px;
        background: #ff9b00 !important;
        color: white;
        border-radius: 8px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 16px;
        flex-shrink: 0;
    }

    .info-content {
        flex: 1;
    }

    .info-label {
        font-size: 13px;
        color: #64748b;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 4px;
    }

    .info-value {
        font-size: 16px;
        color: #1e293b;
        font-weight: 600;
        line-height: 1.5;
    }

    /* Order Table */
    .order-table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: var(--shadow-sm);
    }

        .order-table thead {
            background: linear-gradient(135deg, var(--color-primary), var(--color-primary-dark));
        }

        .order-table th {
            padding: 16px;
            text-align: left;
            font-size: 14px;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .order-table tbody tr {
            transition: all 0.2s ease;
        }

            .order-table tbody tr:hover {
                background: #f0fdf4;
                transform: scale(1.01);
            }

        .order-table td {
            padding: 18px 16px;
            font-size: 15px;
            color: #334155;
            border-bottom: 1px solid #f1f5f9;
            vertical-align: middle;
        }

    .product-name {
        font-weight: 600;
        color: #1e293b;
    }

    .product-qty {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 6px 14px;
        background: var(--color-primary);
        color: white;
        border-radius: 8px;
        font-weight: 700;
        font-size: 14px;
        min-width: 45px;
    }

    .product-price,
    .product-total {
        font-weight: 700;
        color: var(--color-primary);
        font-size: 16px;
    }

    /* Payment Methods */
    .payment-methods {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin: 20px 0;
    }

    .payment-method {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 20px;
        background: #f8fafc;
        border: 2px solid #e2e8f0;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .payment-method:hover {
            background: #f0fdf4;
            border-color: var(--color-primary);
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .payment-method.selected {
            background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
            border-color: var(--color-primary);
            border-width: 3px;
        }

    .payment-method-icon {
        font-size: 32px;
        color: var(--color-primary);
        margin-bottom: 10px;
    }

    .payment-method-name {
        font-size: 14px;
        font-weight: 600;
        color: #1e293b;
        text-align: center;
    }

    /* Order Summary Sidebar */
    .order-summary-sticky {
        position: sticky;
        top: 20px;
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 0;
        border-bottom: 1px dashed #e2e8f0;
        font-size: 15px;
    }

    .summary-label {
        color: #64748b;
        font-weight: 500;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .summary-value {
        color: #1e293b;
        font-weight: 700;
    }

    /* Grand Total */
    .grand-total-box {
        background: linear-gradient(135deg, #dcfce7 0%, #bbf7d0 100%);
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .grand-total-label {
        font-size: 18px;
        font-weight: 700;
        color: var(--color-primary-dark);
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .grand-total-value {
        font-size: 28px;
        font-weight: 800;
        color: var(--color-primary);
    }

    /* Checkout Button */
    .checkout-btn-final {
        background: #177e3f !important;
        color: white;
        font-size: 18px;
        font-weight: 700;
        width: 100%;
        padding: 18px 30px;
        border-radius: 12px;
        margin-top: 20px;
        text-align: center;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 12px;
        border: none;
        box-shadow: 0 10px 30px rgba(23, 126, 63, 0.3);
        transition: all 0.3s ease;
        text-decoration: none;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        cursor: pointer;
    }

        .checkout-btn-final:hover {
            background: linear-gradient(135deg, var(--color-primary-dark), var(--color-primary)) !important;
            transform: translateY(-3px);
            box-shadow: 0 15px 40px rgba(23, 126, 63, 0.4);
            color: white;
            text-decoration: none;
        }

    /* Security Badge */
    .security-badge {
        display: flex;
        align-items: center;
        gap: 12px;
        padding: 15px;
        background: #f0fdf4;
        border-radius: 10px;
        margin-top: 15px;
        border: 1px solid #bbf7d0;
    }

        .security-badge i {
            font-size: 24px;
            color: var(--color-success);
        }

    .security-badge-text {
        flex: 1;
    }

        .security-badge-text strong {
            display: block;
            font-size: 14px;
            color: var(--color-primary);
            margin-bottom: 2px;
        }

        .security-badge-text span {
            font-size: 12px;
            color: #64748b;
        }

    /* Hidden sections */
    .hidden {
        display: none !important;
    }
</style>

<div class="checkout-wrapper">
    <!-- Progress Steps -->
    <div class="progress-steps">
        <div class="progress-line-active" id="progressLine"></div>
        <div class="step completed" id="step1">
            <div class="step-icon">
                <i class="fas fa-shopping-cart"></i>
            </div>
            <span class="step-label">Cart</span>
        </div>
        <div class="step active" id="step2">
            <div class="step-icon">
                <i class="fas fa-clipboard-list"></i>
            </div>
            <span class="step-label">Review Order</span>
        </div>
        <div class="step" id="step3">
            <div class="step-icon">
                <i class="fas fa-credit-card"></i>
            </div>
            <span class="step-label">Payment</span>
        </div>
        <div class="step" id="step4">
            <div class="step-icon">
                <i class="fas fa-check-circle"></i>
            </div>
            <span class="step-label">Confirmation</span>
        </div>
    </div>

    @if (Model.CartItems == null || Model.CartItems.Count == 0)
    {
        <div class="checkout-section">
            <div style="text-align: center; padding: 60px 20px;">
                <i class="fas fa-shopping-basket" style="font-size: 80px; color: #cbd5e0; margin-bottom: 20px;"></i>
                <h3 style="font-size: 24px; font-weight: 700; color: #475569; margin-bottom: 12px;">Your cart is empty</h3>
                <p style="font-size: 16px; color: #94a3b8;">Add some items to your cart to proceed</p>
                <a href="/Customer/Index" class="checkout-btn-final" style="width: auto; display: inline-flex; margin-top: 20px;">
                    <i class="fas fa-arrow-left"></i>
                    Continue Shopping
                </a>
            </div>
        </div>
    }
    else
    {
        <div class="checkout-grid">
            <!-- Left Column -->
            <div>
                <!-- User Details Section -->
                <div class="checkout-section" id="reviewSection">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-user"></i>
                        </div>
                        <h2 class="section-title">Delivery Information</h2>
                        <a href="/Account/Profile" style="color: var(--color-primary); font-size: 14px; font-weight: 600;">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                    </div>
                    <div>
                        <div class="info-item">
                            <div class="info-icon">
                                <i class="fas fa-user"></i>
                            </div>
                            <div class="info-content">
                                <div class="info-label">Full Name</div>
                                <div class="info-value">@Model.UserName</div>
                            </div>
                            <div class="info-icon">
                                <i class="fas fa-phone"></i>
                            </div>
                            <div class="info-content">
                                <div class="info-label">Phone Number</div>
                                <div class="info-value">@Model.Mobile</div>
                            </div>
                        </div>
                        <div class="info-item">
                            <div class="info-icon">
                                <i class="fas fa-map-marker-alt"></i>
                            </div>
                            <div class="info-content">
                                <div class="info-label">Delivery Address</div>
                                <div class="info-value">@Model.Address</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Order Items Section -->
                <div class="checkout-section my-3" id="itemsSection">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-box"></i>
                        </div>
                        <h2 class="section-title">Order Items (@Model.CartItems.Count)</h2>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="order-table">
                            <thead>
                                <tr>
                                    <th>Product</th>
                                    <th style="text-align: center;">Quantity</th>
                                    <th style="text-align: right;">Price</th>
                                    <th style="text-align: right;">Total</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.CartItems)
                                {
                                    <tr>
                                        <td class="product-name">@item.Name</td>
                                        <td style="text-align: center;">
                                            <span class="product-qty">@item.Qty</span>
                                        </td>
                                        <td class="product-price" style="text-align: right;">₹@item.Price</td>
                                        <td class="product-total" style="text-align: right;">₹@((item.Qty * item.Price).ToString("N2"))</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Payment Method Section (Hidden Initially) -->
                <div class="checkout-section my-3 hidden" id="paymentSection">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-wallet"></i>
                        </div>
                        <h2 class="section-title">Select Payment Method</h2>
                    </div>
                    <div class="payment-methods">
                        <div class="payment-method selected" data-method="cod">
                            <div class="payment-method-icon">
                                <i class="fas fa-money-bill-wave"></i>
                            </div>
                            <div class="payment-method-name">Cash on Delivery</div>
                        </div>
                        <div class="payment-method" data-method="upi">
                            <div class="payment-method-icon">
                                <i class="fas fa-mobile-alt"></i>
                            </div>
                            <div class="payment-method-name">UPI Payment</div>
                        </div>
                        <div class="payment-method" data-method="card">
                            <div class="payment-method-icon">
                                <i class="fas fa-credit-card"></i>
                            </div>
                            <div class="payment-method-name">Debit/Credit Card</div>
                        </div>
                        <div class="payment-method" data-method="wallet">
                            <div class="payment-method-icon">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="payment-method-name">Digital Wallet</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column - Order Summary -->
            <div class="order-summary-sticky">
                <div class="checkout-section">
                    <div class="section-header">
                        <div class="section-icon">
                            <i class="fas fa-receipt"></i>
                        </div>
                        <h2 class="section-title">Order Summary</h2>
                    </div>

                    <div>
                        <div class="summary-row">
                            <span class="summary-label">
                                <i class="fas fa-shopping-bag"></i>
                                Items (@Model.CartItems.Count)
                            </span>
                            <span class="summary-value">@Model.CartItems.Sum(x => x.Qty)</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">
                                <i class="fas fa-tag"></i>
                                Subtotal
                            </span>
                            <span class="summary-value">₹@Model.GrandTotal.ToString("N2")</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">
                                <i class="fas fa-truck"></i>
                                Shipping
                            </span>
                            <span class="summary-value" style="color: var(--color-success);">FREE</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">
                                <i class="fas fa-percent"></i>
                                Tax
                            </span>
                            <span class="summary-value">₹0.00</span>
                        </div>
                    </div>

                    <div class="grand-total-box">
                        <span class="grand-total-label">
                            <i class="fas fa-wallet"></i>
                            Grand Total
                        </span>
                        <span class="grand-total-value">₹@Model.GrandTotal.ToString("N2")</span>
                    </div>

                    <button class="checkout-btn-final" id="proceedBtn" onclick="proceedToPayment()">
                        Proceed to Payment
                        <i class="fas fa-arrow-right"></i>
                    </button>

                    <button class="checkout-btn-final hidden" id="completeBtn" onclick="completeOrder()">
                        <i class="fas fa-lock"></i>
                        Complete Order
                        <i class="fas fa-arrow-right"></i>
                    </button>

                    <div class="security-badge">
                        <i class="fas fa-shield-alt"></i>
                        <div class="security-badge-text">
                            <strong>Secure Checkout</strong>
                            <span>Your information is protected with 256-bit SSL encryption</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
</div>

<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // ================================================================
    // CHECKOUT PAGE SCRIPT - CLEAN & FIXED
    // ================================================================

    // Progress Bar Update
    function updateProgressBar(stepNumber) {
        const steps = document.querySelectorAll('.step');
        const progressLine = document.getElementById('progressLine');

        const progressPercent = ((stepNumber - 1) / 3) * 70;
        progressLine.style.width = progressPercent + '%';

        steps.forEach((step, index) => {
            const stepNum = index + 1;
            step.classList.remove('active', 'completed');

            if (stepNum < stepNumber) {
                step.classList.add('completed');
            } else if (stepNum === stepNumber) {
                step.classList.add('active');
            }
        });
    }

    // Initialize Page
    document.addEventListener('DOMContentLoaded', function () {
        updateProgressBar(2); // Step 2 = Review Order

        document.querySelectorAll('.payment-method').forEach(method => {
            method.addEventListener('click', function () {
                document.querySelectorAll('.payment-method').forEach(m => m.classList.remove('selected'));
                this.classList.add('selected');
            });
        });
    });

    // Proceed to Payment Section
    function proceedToPayment() {
        document.getElementById('paymentSection').classList.remove('hidden');
        document.getElementById('proceedBtn').classList.add('hidden');
        document.getElementById('completeBtn').classList.remove('hidden');

        updateProgressBar(3);

        document.getElementById('paymentSection').scrollIntoView({
            behavior: 'smooth',
            block: 'center'
        });

        Swal.fire({
            icon: 'success',
            title: 'Ready for Payment!',
            text: 'Please select your preferred payment method',
            timer: 2000,
            showConfirmButton: false,
            toast: true,
            position: 'top-end'
        });
    }

    // Save Order to Server
    function completeOrder() {

        var paymentMethod = $(".payment-method.selected").data("method") || "COD";

        $.ajax({
            url: "/Customer/SaveOrder",
            type: "POST",
            data: { paymentMethod: paymentMethod },

            success: function (response) {
                if (response.status === "success") {

                    // Clear cart
                    let userId = '@Session["UserId"]';
                    let key = "cart_user_" + userId;
                    localStorage.removeItem(key);

                    if (typeof renderCart === 'function') {
                        renderCart();
                    }

                    // Redirect to success page
                    window.location.href = "/Customer/Success?orderId=" + response.orderId;
                }
                else {
                    Swal.fire({
                        icon: 'error',
                        title: 'Order Failed',
                        text: response.message
                    });
                }
            },

            error: function () {
                Swal.fire({
                    icon: 'error',
                    title: 'Server Error',
                    text: 'Unable to place order at this moment.'
                });
            }
        });
    }
</script>
