@{
    ViewBag.Title = "Cart";
    Layout = "~/Views/Shared/_CustomerLayout.cshtml";
}

<style>

    :root {
        --color-primary: #177e3f !important;
    }

    .cart-container {
        min-height: 100vh;
        padding: 40px 0;
    }

    .cart-card {
        background: white;
        border-radius: 10px;
        box-shadow: 0 0px 5px rgba(0,0,0,0.3);
        overflow: hidden;
        border: none;
    }

    .cart-header {
        color: white;
        padding: 30px;
        border-bottom: 4px solid #087c23;
    }

    .order-summary {
        color: white;
        padding: 30px;
    }

    .cart-header h2 {
        margin: 0;
        font-weight: 700;
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .cart-header i {
        font-size: 2rem;
    }

    .badge-count {
        background: #1b8905;
        color: white;
        border-radius: 20px;
        padding: 5px 15px;
        font-size: 1.5rem;
        font-weight: 600;
    }

    .table-container {
        padding: 30px;
    }

    .cart-table {
        background: white;
        border-radius: 12px;
        overflow: hidden;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
        margin-bottom: 0;
    }

        .cart-table thead {
            background: #f4f4f4 !important;
            color: black;
        }

            .cart-table thead th {
                border: none;
                padding: 18px 15px;
                font-weight: 600;
                text-transform: uppercase;
                font-size: 14px !important;
                letter-spacing: 0.5px;
                vertical-align: middle;
            }

        .cart-table tbody tr td {
            transition: all 0.3s ease;
            border-bottom: 1px solid #e9ecef;
        }

        .cart-table tbody tr:hover {
            background-color: #f8f9ff;
            transform: scale(1.01);
        }

        .cart-table tbody tr:last-child {
            border-bottom: none;
        }

        .cart-table tbody td {
            padding: 20px 15px;
            vertical-align: middle;
        }

    .product-info {
        display: flex;
        align-items: center;
        gap: 15px;
    }

    .product-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 18px;
        border: 3px solid #e2e8f0;
        transition: all 0.3s ease;
    }

        .product-image:hover {
            transform: scale(1.1);
            border-color: #667eea;
        }

    .product-name {
        font-weight: 600;
        color: #2d3748;
        font-size: 18px !important;
    }

    .qty-badge {
        background: #1b8905;
        color: white;
        padding: 10px 20px;
        border-radius: 10px;
        font-weight: 700;
        font-size: 18px !important;
        display: inline-block;
        min-width: 60px;
        text-align: center;
    }

    .price-text {
        font-weight: 700;
        color: #1b8905;
        font-size: 16px;
    }

    .total-text {
        font-weight: 800;
        color: #2d3748;
        font-size: 18px;
    }

    .remove-btn {
        background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
        color: white;
        border: none;
        padding: 12px 18px;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 600;
        font-size: 14px !important;
        width: 50px;
    }

        .remove-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 15px rgba(245, 101, 101, 0.4);
        }

        .remove-btn i {
            margin-right: 5px;
        }

    .cart-summary {
        background: linear-gradient(135deg, #f7fafc 0%, #edf2f7 100%);
        padding: 30px;
        border-top: 3px solid #e2e8f0;
    }

    .summary-box {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 6px rgba(0,0,0,0.05);
    }

    .summary-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 15px 0;
        border-bottom: 2px dashed #e2e8f0;
    }

        .summary-row:last-child {
            border-bottom: none;
        }

    .summary-label {
        font-size: 16px !important;
        color: #4a5568;
        font-weight: 500;
    }

    .summary-value {
        font-size: 18px !important;
        font-weight: 700;
        color: #2d3748;
    }

    .grand-total-box {
        /*        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);*/
        color: black !important;
        padding: 25px;
        border-radius: 15px;
        margin-top: 20px;
        box-shadow: 0 5px 10px rgba(102, 126, 234, 0.3);
    }

        .grand-total-box .summary-label {
            color: black !important;
            font-size: 18px !important;
        }

        .grand-total-box .summary-value {
            color: black !important;
            font-size: 18px !important;
        }

    .checkout-btn {
        background: var(--color-primary);
        color: white;
        border: none;
        padding: 20px 50px;
        font-size: 18px !important;
        font-weight: 700;
        border-radius: 12px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
        width: 100%;
        margin-top: 20px;
        box-shadow: 0 10px 25px rgba(72, 187, 120, 0.3);
        text-decoration: none;
        display: block;
        text-align: center;
    }

        .checkout-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 15px 35px rgba(72, 187, 120, 0.4);
            color: white;
        }

        .checkout-btn i {
            margin-right: 10px;
        }

    .empty-cart {
        text-align: center;
        padding: 80px 30px;
        color: #718096;
    }

        .empty-cart i {
            font-size: 18px !important;
            color: #cbd5e0;
            margin-bottom: 25px;
        }

        .empty-cart h3 {
            font-size: 18px !important;
            font-weight: 700;
            color: #2d3748;
            margin-bottom: 15px;
        }

        .empty-cart p {
            font-size: 18px !important;
            color: var(--color-primary);
        }

    .continue-shopping {
        background: var(--color-primary);
        color: white;
        padding: 15px 40px;
        border-radius: 10px;
        text-decoration: none;
        display: inline-block;
        margin-top: 20px;
        font-weight: 600;
        transition: all 0.3s ease;
        height: 51px !important;
    }

        .continue-shopping:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
            color: white;
        }

    .qty-box {
        display: flex;
        align-items: center;
        gap: 12px;
        border: 2px solid var(--color-primary);
        padding: 6px 14px;
        border-radius: 10px;
        width: fit-content;
    }

    .qty-minus,
    .qty-plus {
        background: none;
        border: none;
        font-size: 22px;
        cursor: pointer;
        color: black;
        padding: 0;
        font-weight: bold;
    }

    .qty-number {
        font-size: 18px;
        font-weight: bold;
        min-width: 20px;
        text-align: center;
    }
</style>

<div class="cart-container">
    <div class="container">
        <div class="row">

            <div class="col-sm-7">
                <div class="cart-card">
                    <div class="cart-header">
                        <h2>
                            <i class="fas fa-shopping-cart"></i>
                            Shopping Cart
                            <span class="badge-count" id="itemCount">0</span>
                        </h2>
                    </div>

                    <div class="table-container">
                        <div class="table-responsive">
                            <table class="table cart-table">
                                <thead>
                                    <tr>
                                        <th style="width: 40%;">Product</th>
                                        <th style="width: 15%;">Quantity</th>
                                        <th style="width: 15%;">Price</th>
                                        <th style="width: 15%;">Total</th>

                                    </tr>
                                </thead>
                                <tbody id="cartTableBody" style="font-size:16px !important;">
                                    <!-- Cart items will be inserted here -->
                                </tbody>
                            </table>
                        </div>

                        <div id="emptyCart" class="empty-cart" style="display: none;">
                            <i class="fas fa-shopping-basket"></i>
                            <h3>Your cart is empty</h3>
                            <p>Looks like you haven't added anything to your cart yet.</p>
                            <a href="/Customer/Index" class="continue-shopping">
                                <i class="fas fa-arrow-left"></i> Continue Shopping
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-sm-5">
                <div class="cart-card">
                    <div class="order-summary">
                        <h3>
                            <i class="fas fa-file-invoice-dollar"></i>
                            Order Summary
                        </h3>



                        <div class="summary-row">
                            <span class="summary-label">
                                <i class="fas fa-box"></i> Items in Cart
                            </span>
                            <span class="summary-value" id="totalItems">0</span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">
                                <i class="fas fa-tag"></i> Subtotal
                            </span>
                            <span class="summary-value">₹<span id="subtotal">0</span></span>
                        </div>
                        <div class="summary-row">
                            <span class="summary-label">
                                <i class="fas fa-truck"></i> Shipping
                            </span>
                            <span class="summary-value text-success">FREE</span>
                        </div>

                        <div class="grand-total-box">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span class="summary-label">Grand Total</span>
                            </div>
                            <div class="text-end">
                                <span class="summary-value">₹<span id="grandTotal">0</span></span>
                            </div>
                        </div>

                        @*<a href="javascript:void(0)"
                               class="checkout-btn"
                               id="checkoutBtn"
                               onclick="checkLoginBeforePayment()">
                                <i class="fas fa-lock"></i> Proceed To Checkout
                            </a>*@

                        <a href="/Customer/Checkout" id="checkoutBtn" class="btn btn-success p-3 w-100 my-4 fs-3 rounded rounded-3">Proceed To Checkout</a>


                    </div>
                </div>


            </div>
        </div>
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.7.1.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
// ================================================================
// CART PAGE - FINAL FIXED VERSION (CLEAN + NO DUPLICATE CODE)
// ================================================================

// ---------------------------------------------------------------
// GET USER CART KEY
// ---------------------------------------------------------------
function getUserCartKey() {
    let userId = '@Session["UserId"]' || localStorage.getItem("UserId") || "guest";
    return "cart_user_" + userId;
}

// ---------------------------------------------------------------
// LOAD CART
// ---------------------------------------------------------------
function loadCart() {
    let key = getUserCartKey();
    let cartData = localStorage.getItem(key);
    return cartData ? JSON.parse(cartData) : [];
}

// ---------------------------------------------------------------
// SAVE CART
// ---------------------------------------------------------------
function saveCart(cart) {
    let key = getUserCartKey();
    localStorage.setItem(key, JSON.stringify(cart));

    updateCartDisplay(cart);

    if (typeof renderCart === "function") {
        renderCart();
    }
}

// ---------------------------------------------------------------
// UPDATE CART DISPLAY
// ---------------------------------------------------------------
function updateCartDisplay(cart) {
    const tbody = document.getElementById("cartTableBody");
    const emptyCart = document.getElementById("emptyCart");
    const tableContainer = document.querySelector(".table-responsive");
    const checkoutBtn = document.getElementById("checkoutBtn");

    let html = "";
    let grandTotal = 0;
    let totalQty = 0;

    if (!cart || cart.length === 0) {
        if (tbody) tbody.innerHTML = "";
        if (emptyCart) emptyCart.style.display = "block";
        if (tableContainer) tableContainer.style.display = "none";

        if (checkoutBtn) {
            checkoutBtn.classList.add("disabled");
            checkoutBtn.style.pointerEvents = "none";
            checkoutBtn.style.opacity = "0.5";
        }

        setSummary(0, 0, 0);

        updateHeaderCount(0);
        return;
    }

    emptyCart.style.display = "none";
    if (tableContainer) tableContainer.style.display = "block";

    if (checkoutBtn) {
        checkoutBtn.classList.remove("disabled");
        checkoutBtn.style.pointerEvents = "auto";
        checkoutBtn.style.opacity = "1";
    }

    cart.forEach(item => {
        let total = item.price * item.qty;
        grandTotal += total;
        totalQty += Number(item.qty);

        html += `
            <tr>
                <td>
                    <div class="product-info">
                        <img src="${item.image}" class="product-image">
                        <span class="product-name">${item.name}</span>
                    </div>
                </td>

                <td>
                    <div class="qty-box">
                        <button onclick="decreaseQty('${item.id}')" class="qty-minus">−</button>
                        <span class="qty-number">${item.qty}</span>
                        <button onclick="increaseQty('${item.id}')" class="qty-plus">+</button>
                    </div>
                </td>

                <td class="price-text">₹${item.price}</td>
                <td class="total-text">₹${total.toFixed(2)}</td>
            </tr>
        `;
    });

    tbody.innerHTML = html;

    setSummary(grandTotal, cart.length, totalQty);

    updateHeaderCount(cart.length);
}

// ---------------------------------------------------------------
// SUMMARY UPDATE
// ---------------------------------------------------------------
function setSummary(total, uniqueCount, qtyCount) {
    document.getElementById("grandTotal").innerText = total.toFixed(2);
    document.getElementById("subtotal").innerText = total.toFixed(2);
    document.getElementById("itemCount").innerText = uniqueCount;
    document.getElementById("totalItems").innerText = qtyCount;
}

// ---------------------------------------------------------------
// UPDATE HEADER COUNT
// ---------------------------------------------------------------
function updateHeaderCount(count) {
    if (document.getElementById("cartCount"))
        document.getElementById("cartCount").innerText = count;

    if (document.getElementById("cartCountHeader"))
        document.getElementById("cartCountHeader").innerText = count;
}

// ---------------------------------------------------------------
// INCREASE QTY
// ---------------------------------------------------------------
function increaseQty(id) {
    let cart = loadCart();
    let item = cart.find(x => String(x.id) === String(id));

    if (item) {
        item.qty = Number(item.qty) + 1;
        saveCart(cart);
    }
}

// ---------------------------------------------------------------
// DECREASE QTY
// ---------------------------------------------------------------
function decreaseQty(id) {
    let cart = loadCart();
    let item = cart.find(x => String(x.id) === String(id));

    if (!item) return;

    if (Number(item.qty) > 1) {
        item.qty = Number(item.qty) - 1;
        saveCart(cart);
    } else {
        Swal.fire({
            title: "Remove Item?",
            icon: "warning",
            showCancelButton: true,
            confirmButtonColor: "#1b8905",
            cancelButtonColor: "#d33",
            confirmButtonText: "Remove"
        }).then(result => {
            if (result.isConfirmed) removeFromCart(id);
        });
    }
}

// ---------------------------------------------------------------
// REMOVE ITEM
// ---------------------------------------------------------------
function removeFromCart(id) {
    let cart = loadCart().filter(p => String(p.id) !== String(id));
    saveCart(cart);
}

// ---------------------------------------------------------------
// CHECK LOGIN BEFORE PROCEEDING
// ---------------------------------------------------------------
function checkLoginBeforePayment() {
    let cart = loadCart();

    if (cart.length === 0) {
        Swal.fire("Cart Empty", "Please add items before checkout.", "warning");
        return false;
    }

    var isLoggedIn = '@(Session["UserId"] != null ? "true" : "false")';

    if (isLoggedIn === "false") {
        Swal.fire({
            title: "Login Required",
            text: "Please login before checkout.",
            icon: "info",
            showCancelButton: true,
            confirmButtonText: "Login",
            confirmButtonColor: "#1b8905"
        }).then(result => {
            if (result.isConfirmed) window.location.href = "/Account/userlogin";
        });

        return false;
    }

    return true;
}

// ---------------------------------------------------------------
// LOAD CART ON PAGE READY
// ---------------------------------------------------------------
document.addEventListener("DOMContentLoaded", loadFullCart);
$(document).ready(loadFullCart);
setTimeout(loadFullCart, 100);

function loadFullCart() {
    updateCartDisplay(loadCart());
}
</script>
